on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  workflow_dispatch:
  
jobs:
  deploy:
    name: run pull
    runs-on: ubuntu-latest
    
    steps:
    - name: create .ssh folder
      run: mkdir -p "~/.ssh"

    - name: change chmod
      run: chmod 0700 "~/.ssh"

    - name: create file
      uses: mobiledevops/secret-to-file-action@v1
      with:
        base64-encoded-secret: ${{ secrets.DO_PRIVATE_KEY }}
        filename: "id_rsa"
        is-executable: true
        working-directory: "~/.ssh"

    - name: add host to known hosts
      run: ssh-keyscan -H "${{ secrets.SSH_HOST }}" > ~/.ssh/known_hosts

    - name: connect and pull
      run: ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.WORK_DIR }} && git checkout ${{ secrets.MAIN_BRANCH }} && git pull && exit"

    - name: restart server
      run: sudo systemctl restart gunicorn

    - name: cleanup
      run: rm -rf ~/.ssh